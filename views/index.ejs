<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>socket_demo</title>
    <script src="/javascripts/jquery-1.11.1.js"></script>
    <script src="/javascripts/socket.io-1.4.5.js"></script>
    <style>
        *{
            margin:0;
            padding:0;
            font-family: MicroSoft YaHei;
        }
        ul{
            list-style: none;
        }
        body{
            position: absolute;
            width:100%;
            height:100%;
        }
        #userList{
            width:200px;
            height:100%;
            overflow: auto;
            float:left;
            background:rgb(5,155,210);
        }
        #userList li{
            margin:5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space:nowrap; 
            text-indent: 1em;
            line-height:30px;
            border-radius: 6px;
            font-size:16px;
            cursor:pointer;
            color:#fff;
        }
        #userList li:hover{
            background:rgb(135,205,235);
        }
        .chat_container{
            height:100%;
            margin-left:200px;
            background:rgb(245,245,245);
            overflow: hidden;
        }
        #tab_title{
            height:22%;
            border-bottom:3px solid rgb(5,155,210);
            position: relative;
        }
        #tab_title h1{
            margin:0 10px;
            font-size:#666;
            font-weight: 600;
        }
        #tab_title ul{
            position: absolute;
            width:100%;
            bottom:0;
        }
        #chat_contents{
            position: relative;
            height:78%;
            overflow: hidden;
        }
        #chat_contents>li{
            display:none;
            overflow: auto;
            height:100%;
        }
        .chat_content{
            margin-bottom:60px;
        }
        #tab_title .title{
            display: inline-block;
            margin:0 5px;
            padding:5px 8px;
            position: relative;
            border-radius:5px 5px 0 0;
            background:rgb(135,205,235);
            cursor:pointer;
            color:#333;
            
        }
        #tab_title li.active{
            background:rgb(5,155,210);
        }
        .close{
            position: absolute;
            width:12px;
            height:12px;
            line-height: 9px;
            text-align:center;
            font-size: 12px;
            color:#fff;
            background:#999;
            border-radius:50%;
            cursor:pointer;
            top:1px;
            right:2px;
        }
        .close:hover{
            background:#666;
        }
        #bg{
            position: fixed;
            width:100%;
            height:100%;
            top:0;
            left:0;
            background:rgba(50,50,50,0.4);
            z-index:9;
        }
        #login{
            position: fixed;
            width:200px;
            height:100px;
            border:1px solid #ccc;
            border-radius:10px;
            box-shadow: 0 0 10px gray;
            top:50%;
            left:50%;
            margin-left:-100px;
            margin-top:-50px;
            background:#fff;
            z-index:99;
        }
        #login div{
            margin:5px 10px;
        }
        #login button{
            border:none;
            border-radius: 5px;
            background:rgb(5,155,210);
            padding:5px 10px;
            color:#fff;
            cursor:pointer;
        }
        .chat_content .tips{
            text-align:center;
            font-size:12px;
            color:gray;
        }
        .chat_content div{
            margin:10px;
            overflow: hidden;
        }
        .chat_submit{
            position: absolute;
            bottom:0;
            width:100%;
            padding:10px 0;
            background:rgb(5,155,210);
        }
        .chat_submit input{
            width:80%;
            height:24px;
            border:1px solid #fff;
            border-radius:5px;
        }
        .chat_submit button{
            background:rgb(185,255,235);
            border:1px solid #fff;
            border-radius:5px;
            height:26px;
            width:19%;
            text-align:center;
            line-height: 26px;
            font-size: 16px;
            padding:0 10px;
            color:#333;
            cursor:pointer;
            text-shadow: 0 0 5px #fff;
        }
        .user_num{
            color:#fff;
            text-align:center;
        }
        .self{
            padding: 1em;
            color:#fff;
        }
        .self span{
            display: inline-block;
            margin-right:5px;
            text-align:right;
            width:50px;
        }
        #tab_title .active{
            background:rgb(135,205,235);
        }
        #chat_contents .active{
            display:block;
        }
        .me span{
            display:inline-block;
            float:right;
        }
        #chat_contents .text{
            margin:0px 10px;
            font-size:10px;
            color:gray;
        }
        .me .text{
            text-align:right;
        }
        .other span{
            display:inline-block;
        }
        .msg{
            padding:5px 10px;
            background:rgb(135,205,235);
            border-radius:10px;
            max-width: 50%;
        }
        .username{
            padding:5px 10px;
            font-size:16px;
            font-weight:600;
        }
        #tab_title h1 button{
            cursor: pointer;
            border:none;
            background:rgb(5,155,210);
            color:#fff;
            font-weight: 600;
            font-size: 16px;
            margin:0 10px;
        }
        #videoCon{
            display: none;
            width:640px;
            height:440px;
            border:1px solid rgb(5,155,210);
            box-shadow: 0 0 10px rgb(5,155,210);
            border-radius:5px;
            position: fixed;
            top:50%;
            margin-top:-220px;
            left:50%;
            margin-left:-320px;
            background: #fff;
        }
        #videoSelf{
            width:180px;
            right:0;
            bottom:0;
        }
    </style>
</head>
<body>
        <div id="userList">
            <div>
                <div class="self"></div>
                <div class='user_num'></div>
            </div>
            <ul>
            </ul>
        </div>
        <div class="chat_container">
            <div id="tab_title">
                <h1>commonality</h1>
                <ul>
                    <li class="commonality_title title active"><span class="text">commonality</span></li>
                </ul>
            </div>
            <ul id="chat_contents">
                <li class="commonality active" value="commonality">
                    <div class="chat_content"></div>
                    <div class="chat_submit">
                        <input type="text" class="input">
                        <button class="submit">提交</button>
                    </div>
                </li>
            </ul>

        </div>
        <div id="videoCon">
            <video src="" id="video"></video>
            <video src="" id="videoSelf"></video>
        </div>
        <% include logout.ejs %>
        <!-- <div id="login">
            <div><label for="username">昵称：</label><span>(3~8个字符)</span></div>
            <div><input type="text" id="username" name="chatusername"></div>
            <div><button id="confirm">确定</button></div>
        </div>
        <div id="bg"></div> -->
</body>
<script>
var socket = io();
var chatType,id,name;
//$("#confirm").click(function(){
    // if($("#username").val().length<3||$("#username").val().length>8)
    //     return;
    id="ID<%= username%>";
    name="<%= username%>";
    // $("#login,#bg").hide();
//if(name!="object Object"){
    socket.emit('login', {"userid":id,"username":name});

    socket.on('login', function (data) {
        $('#chat_contents .commonality .chat_content').append("<div class='tips'><span>欢迎用户"+data.user+"加入房间</span></div>");
        $("#userList ul").html("");
        $("#userList .user_num").html("在线人数："+data.onlineCount);
        for(key in data.onlineUsers){
            if(key!=id)
                $("#userList ul").prepend("<li value="+key+">"+data.onlineUsers[key]+" <small>[<i>"+key+"</i>]</small></li>");
            else
                $("#userList .self").html("<span>name:</span><big>"+data.onlineUsers[key]+"</big><br /><span>id:</span>"+key)
        }
        event();
    });
    socket.on('logout', function(data) {
        //$('#chat_contents .commonality .chat_content').append("<div class='tips'><span>欢迎用户"+data.user+"加入房间</span></div>");
        $("#userList ul").html("");
        $("#userList .user_num").html("在线人数："+data.onlineCount);
        for(key in data.onlineUsers){
            if(key!=id)
                $("#userList ul").prepend("<li value="+key+">"+data.onlineUsers[key]+" <small>[<i>"+key+"</i>]</small></li>");
            else
                $("#userList .self").html("<span>name:</span><big>"+data.onlineUsers[key]+"</big><br /><span>id:</span>"+key)
        }
        event();
    });
    submit();
    socket.on('to'+id, function(data) {
        var username=data[0];
        var userid=data[1];
        var msg=data[2];

        eventfn(userid,username);
        
        if(msg.video){
            var s=msg.video;
                $("#videoCon").show();
                var video=document.getElementById('video');
                navigator.getUserMedia=navigator.mozGetUserMedia||navigator.webkitGetUserMedia||navigator.msGetUserMedia||navigator.getUserMedia;
                window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL;
                if(navigator.getUserMedia){
                   var err=function(){
                        console.log("无法使用摄像功能");
                    }
                   navigator.getUserMedia({"video":false,"audio":true},function(stream){
                        if(video.mozSrcObject!==undefined){
                            video.mozSrcObject=s;
                        }else{
                            video.src=(window.URL&&window.URL.createObjectURL(s))||s;
                        }
                   },err);
                }
        }else{
            var time=new Date();
            var h=time.getHours(),m=time.getMinutes(),s=time.getSeconds();
            var ele=$('.'+userid);
            ele.find(".chat_content").append("<div class='other'>"+
                "<div class='text'>"+h+":"+m+":"+s+"</div>"+
                "<span class='username'>"+username+"</span><span class='msg'>"+msg+"</span></div>");
            ele.scrollTop(ele.find(".chat_content").height()-ele.height());
        }
    });

    socket.on('chat message', function (data) {
        var username=data[0];
        var userid=data[1];
        var msg=data[2];
        if(userid==id){
            var c="me";
        }else{
            var c="other";
        }
        var time=new Date();
        var h=time.getHours(),m=time.getMinutes(),s=time.getSeconds();
        var ele=$(".commonality");
        ele.find('.chat_content').append("<div class="+c+">"+
            "<div class='text'>"+h+":"+m+":"+s+"</div>"+
            "<span class='username'>"+username+"</span><span class='msg'>"+msg+"</span></div>");
        $(".commonality_title").trigger("click");
        ele.scrollTop(ele.find(".chat_content").height()-ele.height());
    });
//}
function event(){
    $("#userList ul li").off();
    $("#userList ul li").on("dblclick",function(){
            var userid=$(this).attr("value");
            var username=$(this).html();
        if(userid!=id)
            eventfn(userid,username);
    });
}
function eventfn(userid,username){
    if($("#tab_title").find("."+userid).length>0){
            $("#tab_title").find("."+userid).trigger("click");
        }else{
            $("#tab_title ul").append("<li class='title "+userid+"' userId='"+userid+"'><span class='text'>"+username+"</span><span class='close'>x</span></li>");

            $("#chat_contents").append('<li class="'+userid+'" value="'+userid+'">'+
                    '<div class="chat_content"><div class="tips"><span>可以和'+username+'聊天了</span></div></div>'+
                    '<div class="chat_submit">'+
                        '<input type="text" class="input">'+
                        '<button class="submit">提交</button>'+
                    '</div>'+
                '</li>');
        }   

         $("#tab_title .title").each(function(index){
            $(this).off();
            $(this).on("click",function(){
                $("#tab_title .title").removeClass("active");
                $(this).addClass("active");
                $("#chat_contents>li").removeClass("active");
                $("#chat_contents>li").eq(index).addClass("active");
                if($(this).find(".text").html()!="commonality")
                    $("#tab_title h1").html($(this).find(".text").html()+"<button class='videoStart' userId='"+$(this).attr("userId")+"'>视频聊天</button>");
                else
                    $("#tab_title h1").html($(this).find(".text").html());
                video($(".videoStart"));
            });
        });
         function video(e){
            e.off("click").on("click",function(){console.log("click")
                $("#videoCon").show();
                var video=document.getElementById('videoSelf');
                navigator.getUserMedia=navigator.mozGetUserMedia||navigator.webkitGetUserMedia||navigator.msGetUserMedia||navigator.getUserMedia;
                window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL;
                if(navigator.getUserMedia){
                    var err=function(){
                        console.log("无法使用摄像功能");
                    }
                   navigator.getUserMedia({"video":true},function(stream){
                    if(video.mozSrcObject!==undefined){
                        video.mozSrcObject=stream;
                    }else{
                        video.src=(window.URL&&window.URL.createObjectURL(stream))||stream;
                    }
                    console.log(video.src);
                    socket.emit('private message',id,userid,{video:video.src});
                   },err);
                }
            })
         }
         $("#tab_title").find("."+userid).trigger("click");

        $("#tab_title .title .close").each(function(index){
            $(this).off();
            $(this).on("click",function(){
                $(this).parents("li").remove();
                $("#chat_contents>li").eq(index+1).remove();
                $(".commonality_title").trigger("click");
            })
        });
        submit();

}
function submit(){
        $(".submit").off()
        $('.submit').on("click",function(){
                var value=$(this).parent().find(".input").val();
                if(value!=""){
                    var to=$(this).parents("li").attr("value");
                    if(to=="commonality")
                    socket.emit('chat message',id,to,value);
                    else{
                        socket.emit('private message',id,to,value);
                        var time=new Date();
                        var h=time.getHours(),m=time.getMinutes(),s=time.getSeconds();
                        var ele=$('.'+to);
                        ele.find(".chat_content").append("<div class='me'>"+
                            "<div class='text'>"+h+":"+m+":"+s+"</div>"+
                            "<span class='username'>"+name+"</span><span class='msg'>"+value+"</span></div>");
                        ele.scrollTop(ele.find(".chat_content").height()-ele.height());
                    }
                    $('.input').val('');
                }
                return false;
        });
}
</script>
</html>