var mongo=require("mongodb");
var host="localhost";
var server=new mongo.Server(host,27017,{auto_reconnect:true});//创建数据库所在的服务器服务器
var db=new mongo.Db("test",server,{safe:true});//创建数据库对象
var macObj = require('getmac');

var signVerify={};
    signVerify.auth=function(collectionId,callback){
		db.open(function (err,db) {
		    db.collection(collectionId,function(err,collection){
		    	if(err) throw err;
		        else{
		        	callback.call(db,collection);
		        }
		    });
		})
	}
	signVerify.verification=function(req,res,redirect,callback){
		db.open(function (err,db) {
		    db.collection("singlelogin",function(err,collection){
		    	if(err) throw err;
		        else{
		        	//获取cookies
		        	var Cookies={};
		        	if(req.headers.cookie){
			        	req.headers.cookie.split(';').forEach(function( Cookie ) {
					        var parts = Cookie.split('=');
					        if(parts[ 0 ].trim()=="username")
					        	Cookies[ parts[ 0 ].trim() ] = ( parts[ 1 ] || '' ).trim();
					        if(parts[ 0 ].trim()=="clientId")
					        	Cookies[ parts[ 0 ].trim() ] = parts[ 1 ] || '';
					        if(parts[ 0 ].trim()=="tempId")
					        	Cookies[ parts[ 0 ].trim() ] = (parts[ 1 ] || '' ).trim();
					    });
		        	}
		        	//var clientId=uuid.v1();
		        	//获取浏览器信息
		        	var userAgent=req.headers["user-agent"];

		        	if(Cookies.clientId&&Cookies.clientId!=null&&Cookies.username&&Cookies.username!=null&&Cookies.tempId&&Cookies.tempId!=null){
							   	var ipAddress=(req.headers['x-forwarded-for'] || req.connection.remoteAddress || req.socket.remoteAddress || req.connection.socket.remoteAddress);
					        	collection.findOne({clientId:Cookies.clientId,tempId:Cookies.tempId,username:Cookies.username,ipAddress:ipAddress,userAgent:userAgent},function (err,docs){
					        		if(err) throw err;
					        		else{
					        			//console.log(docs);
					        			//console.log(Cookies);
					        			//已登陆
								   		if(docs){
								   			//获取新的时间
						        			var time=new Date().getTime();
					        				if((time-parseInt(docs.time))<600*1000){
					        					var userinfo={username:docs.username};
					        					callback.call(db,collection,userinfo);
					        				//登陆未过期
					        					collection.updateOne(
													  {	clientId:docs.clientId,
													  	username:docs.username,
													  	password:docs.password,
													  	tempId:docs.tempId,
													  	ipAddress:ipAddress,
													  	userAgent:userAgent},
													  {
													  	$set:{time:time}
													  },
													  function(err,docs){
													  	if(err) throw err;
													  	else{
													  		db.close();
														}
													  });
					        				}else{
					        				//登陆已过期
					        					if(redirect!="/")
													res.redirect(redirect||"/login");
												else
													res.render("login");
					        					db.close();
					        				}
								        }else{
								        //未登录
								        	if(redirect!="/")
												res.redirect(redirect||"/login");
											else
												res.render("login");
											db.close();
					        			}
					        		}
						        });
		        	}else{
		        	//cookie不存在
		        		if(redirect!="/")
							res.redirect(redirect);
						else
							res.render("login");
					    db.close();
		        	}
		        }
		    });
		});
	}
module.exports = signVerify;